name: test

on:
  pull_request: {}
  push:
    branches:
      - "**"

env:
  REGISTRY_USER: ckotzbauer
  REGISTRY_TOKEN: ${{ secrets.GHCR_PASSWORD }}
  IS_FORK: ${{ github.event.pull_request.head.repo.full_name != github.repository }}

jobs:
  build-image:
    uses: ckotzbauer/actions-toolkit/.github/workflows/toolkit-build-test.yml@0.29.0
    with:
      install-go: true
      go-version: "1.19.4"
      install-goreleaser: true
      install-cosign: true
      build-commands: make build
      test-commands: |
        if [ "$IS_FORK" != true ]; then
          DATE="$(date +%Y%m%d%H%M%S)"
          docker login -u "$REGISTRY_USER" -p "$REGISTRY_TOKEN" ghcr.io
          docker build --build-arg date=${DATE} -t ghcr.io/ckotzbauer/sbom-operator/oci-test:${DATE} internal/target/oci/fixtures
          docker push ghcr.io/ckotzbauer/sbom-operator/oci-test:${DATE}
          DIGEST=$(docker inspect ghcr.io/ckotzbauer/sbom-operator/oci-test:${DATE} --format='{{index .RepoDigests 0}}')
          syft registry:${DIGEST} -o json > internal/target/oci/fixtures/sbom.json

          TEST_DIGEST="${DIGEST}" go test $(go list ./...) -coverprofile cover.out

          COSIGN_REPOSITORY="ghcr.io/ckotzbauer/sbom-operator/oci-test" cosign download sbom ${DIGEST}
        else
          go test $(go list ./... | grep -v internal/target/oci) -coverprofile cover.out
        fi
      report-coverage: true
      coverage-file: cover.out
      build-image: true
      docker-tag: ghcr.io/ckotzbauer/sbom-operator:latest
      scan-image: true
